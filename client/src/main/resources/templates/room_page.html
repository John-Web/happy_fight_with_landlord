<html xmlns:th="http://www.thymeleaf.org">
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>room_page</title>
    <script type="text/javascript" src="/js/jquery-3.4.1.js"></script>
</head>
<body>
<div id="datas">
    <!--<input th:text="'当前房间人数:' + ${clientsideList.size()}" type="hidden" id="client_size">-->
    <!--<input th:text="'房间号:' + ${room_id}" type="hidden" id="room_id">-->
    <div id="room_id"></div>
    <div id="onlineCount"></div>
</div>
</body>
<script type="text/javascript">
    var room_id = [[${room_id}]];
    var is_owner = 0;                 //玩家默认为非房主
    var index = [[${roomClientCount}]] - 1;      //玩家序号, 房主为0,后面加入的玩家依次为1, 2,       之后向控制器提交确认请求时必须带上index

    var socket;
    if(typeof(WebSocket) == "undefined") {
        alert("您的浏览器不支持WebSocket");
        console.log("您的浏览器不支持WebSocket");
    }
    else{
        socket = new WebSocket("ws://localhost:8090/room_page/"+room_id.toString());

        //打开事件
        socket.onopen = function() {
            console.log("Socket 已打开");
            $('#room_id').text("房间号: "+room_id.toString());
        };
        //获得消息事件
        socket.onmessage = function(msg) {
            var map = eval("(" + msg.data + ")");//解析对象
            for(var key in map){
                if(key == "onlineCount") {
                    var newonlineCount = map[key];
                    $('#onlineCount').text("当前房间人数: "+newonlineCount);
                }
                if(key == "join_type"){
                    if (map[key] == 1){
                        is_owner = 1
                        var str="<input type=\"button\" id=\"buttonbegingame\" value=\"开始游戏\">";
                        $("#datas").append(str);
                    }
                    else if(map[key] == 0 & is_owner==0 & $('#buttongameready').length<=0){
                        var str="<input type=\"button\" id=\"buttongameready\" value=\"准    备\">";
                        $("#datas").append(str);
                    }
                }
                console.log(key+":"+map[key]);
            }
            //发现消息进入    开始处理前端触发逻辑 调用gif逻辑
        };
        //关闭事件
        socket.onclose = function() {
            console.log("Socket已关闭");
        };
        //发生了错误事件
        socket.onerror = function(msg) {
            alert(msg.data);
            alert("Socket发生了错误");
            //此时可以尝试刷新页面
        }
    }
</script>
<script type="text/javascript">
    var op = 0;
    $(document).on('click', '#buttongameready', function(){
        if(op == 0) {
            $('#buttongameready').val("取 消 准 备")
            op=1;
        }
        else if(op == 1){
            $('#buttongameready').val("准    备");
            op=0;
        }
        //提交控制器
        var data={
            'room_id' : room_id,
            'index': index,
            'op': op
        }
        $.ajax({     //请求加入房间, 对接口的要求是返回当前房间里所有的人员信息, 如果需要头像的画可联合数据库查询 必须要留着
            url : 'http://localhost:8090/landlord_servlet/room_servlet/player_confirm_disconfirm_click',
            type : 'POST',
            contentType : 'application/x-www-form-urlencoded',
            dataType : 'json',
            async: false,
            data : data,
            success: function(data){
              alert(data.state_code);
            },
            error : function() {
                alert("error 服务器异常");
            }
        });     //跳转房间页面
    });


    $(document).on('click', '#buttonbegingame', function(){
        //提交控制器
        var data={
            'room_id' : room_id
        }
        $.ajax({     //请求加入房间, 对接口的要求是返回当前房间里所有的人员信息, 如果需要头像的画可联合数据库查询 必须要留着
            url : 'http://localhost:8090/landlord_servlet/room_servlet/owner_begingame_click_check',
            type : 'POST',
            contentType : 'application/x-www-form-urlencoded',
            dataType : 'json',
            async: false,
            data : data,
            success: function(data){
              alert(data.state_code);
            },
            error : function() {
                alert("error 服务器异常");
            }
        });     //跳转房间页面
    });
</script>
</html>